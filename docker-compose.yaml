---
services:
  # ============================================================================
  # Database - ScyllaDB (NoSQL)
  # ============================================================================
  scylladb:
    image: scylladb/scylla:5.4.0 # Use a specific stable version
    container_name: scylladb
    restart: always
    networks:
      - chaty-dev
    ports:
      - "9042:9042" # CQL native protocol
      - "9160:9160" # Thrift protocol (legacy)
      - "10000:10000" # ScyllaDB Manager agent
      - "19042:19042" # JMX
    volumes:
      - scylladb_data:/var/lib/scylla
    command: --smp 1 --memory 2G
    healthcheck:
      test: ["CMD", "cqlsh", "-e", "DESCRIBE keyspaces"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 45s

  cockroachdb:
    image: cockroachdb/cockroach:latest
    container_name: cockroachdb
    restart: always
    networks: ["chaty-dev"]
    command: start-single-node --insecure
    ports:
      - "26257:26257"
      - "8190:8080"
    volumes:
      - cockroach_data:/cockroach/cockroach-data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health?ready=1"]
      interval: 5s
      timeout: 3s
      retries: 10
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"

  chaty_proxy:
    image: envoyproxy/envoy:v1.35.0
    networks: ["chaty-dev"]
    restart: always
    volumes:
      - ./config/envoy.yml:/etc/envoy/envoy.yaml
      - ./bin/chaty_envoy_filter.wasm:/etc/envoy/wasm/chaty_envoy_filter.wasm:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command:
      [
        "-c",
        "/etc/envoy/envoy.yaml",
        "--component-log-level",
        "jwt:debug,http:debug,filter:debug",
      ]
    ports:
      - "8091:8091" # next api server
      - "8092:8092" # next web grpc
      - "9905:9905" # Envoy admin port
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.3"

  # ============================================================================
  # Cache - Dragonfly (Redis-compatible, faster)
  # ============================================================================
  dragonfly:
    image: "docker.dragonflydb.io/dragonflydb/dragonfly"
    container_name: dragonfly
    restart: always
    ulimits:
      memlock: -1
    networks:
      - chaty-dev
    ports:
      - "6379:6379"
    volumes:
      - dragonfly_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1.0"

  # ============================================================================
  # Message Broker - Redpanda (Kafka compatible)
  # ============================================================================
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:latest
    container_name: redpanda
    restart: always
    networks:
      - chaty-dev
    volumes:
      - redpanda_data:/var/lib/redpanda/data
    ports:
      - "19092:19092"
      - "9644:9644"
    command:
      - redpanda
      - start
      - --mode dev-container
      - --smp 1
      - --memory 2G
      - --reserve-memory 0M
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr internal://redpanda:9092,external://localhost:19092
    healthcheck:
      test:
        ["CMD-SHELL", "curl -f http://localhost:9644/v1/node_config || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 15 # Increased retries to handle the slow ScyllaDB startup
      start_period: 90s # Increased to 90s to give the cluster time to initialize
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: "1.0"

  # ============================================================================
  # Object Storage - MinIO (S3-compatible)
  # ============================================================================
  minio:
    image: quay.io/minio/minio:latest
    container_name: minio
    hostname: minio
    restart: always
    networks:
      - chaty-dev
    ports:
      - "9000:9000" # API port
      - "9001:9001" # Console port
    volumes:
      - minio_data:/data
    environment:
      MINIO_ROOT_USER: chaty-dev
      MINIO_ROOT_PASSWORD: chaty-dev-password
      MINIO_CONSOLE_ADDRESS: ":9001"
    command: server /data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"

  # ============================================================================
  # MinIO Bucket Creation
  # ============================================================================
  createbuckets:
    image: minio/mc:latest
    container_name: createbuckets
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - chaty-dev
    entrypoint: >
      /bin/sh -c "
      until /usr/bin/mc ready minio; do
        /usr/bin/mc alias set minio http://minio:9000 chaty-dev chaty-dev-password;
        echo 'Waiting for MinIO...' && sleep 1;
      done;
      /usr/bin/mc mb minio/chaty-uploads;
      /usr/bin/mc mb minio/chaty-avatars;
      /usr/bin/mc mb minio/chaty-files;
      exit 0;
      "
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.2"

  # ============================================================================
  # Mail Server - MailDev (for development)
  # ============================================================================
  maildev:
    image: soulteary/maildev:latest
    container_name: maildev
    restart: always
    networks:
      - chaty-dev
    ports:
      - "1025:25" # SMTP port
      - "8025:8080" # Web UI
    environment:
      MAILDEV_SMTP_PORT: 25
      MAILDEV_WEB_PORT: 8080
      MAILDEV_INCOMING_USER: smtp
      MAILDEV_INCOMING_PASS: smtp
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.2"

  # ============================================================================
  # OAuth 2.0 Authorization Server - Hydra (Database)
  # ============================================================================
  hydra-db:
    image: postgres:15
    container_name: hydra-db
    restart: always
    networks:
      - chaty-dev
    environment:
      POSTGRES_DB: hydra
      POSTGRES_USER: hydra
      POSTGRES_PASSWORD: hydra-password
      POSTGRES_HOST_AUTH_METHOD: trust
    volumes:
      - hydra_db_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hydra -d hydra"]
      interval: 5s
      timeout: 5s
      retries: 10
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"

  # ============================================================================
  # OAuth 2.0 Authorization Server - Hydra (Migration)
  # ============================================================================
  hydra-migrate:
    image: oryd/hydra:v2.2.0
    container_name: hydra-migrate
    networks:
      - chaty-dev
    depends_on:
      hydra-db:
        condition: service_healthy
    environment:
      DSN: postgres://hydra:hydra-password@hydra-db:5432/hydra?sslmode=disable
    command: ["migrate", "sql", "-e", "--yes"]
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.3"

  # ============================================================================
  # OAuth 2.0 Authorization Server - Hydra
  # ============================================================================
  hydra:
    image: oryd/hydra:v2.2.0
    container_name: hydra
    restart: always
    networks:
      - chaty-dev
    depends_on:
      hydra-migrate:
        condition: service_completed_successfully
    ports:
      - "4444:4444" # Public endpoint
      - "4445:4445" # Admin endpoint
    environment:
      DSN: postgres://hydra:hydra-password@hydra-db:5432/hydra?sslmode=disable
      HYDRA_SYSTEM_SECRET: this_needs_to_be_32_bytes_minimum_secret_key_12345
    volumes:
      - ./config/hydra.yml:/config/hydra.yml:ro
    command: ["serve", "all", "--dev", "--config", "/config/hydra.yml"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4444/health/ready"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"

  # ============================================================================
  # Kafka UI (Optional - for Redpanda monitoring)
  # ============================================================================
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    restart: unless-stopped
    networks:
      - chaty-dev
    ports:
      - "8080:8080"
    depends_on:
      redpanda:
        condition: service_healthy
    environment:
      KAFKA_CLUSTERS_0_NAME: "redpanda-local"
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: "redpanda:9092"
      KAFKA_CLUSTERS_0_ZOOKEEPER: ""
      KAFKA_CLUSTERS_0_SCHEMAREGISTRY: "http://redpanda:8081"
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.3"

networks:
  chaty-dev:
    driver: bridge

volumes:
  cockroach_data:
  scylladb_data:
  dragonfly_data:
  redpanda_data:
  minio_data:
  hydra_db_data:
